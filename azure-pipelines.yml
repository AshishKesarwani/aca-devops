# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: windows-latest
variables:
- group: Heco-test-linkedkeyvault
- name: my-passed-variable
  value: $[variables.mysecret] # uses runtime expression

steps:
- script: "echo $(mysecret) | $(Pipeline.Workspace)/secret1.txt" # uses macro syntax
- script: "echo $(my-passed-variable) > $(Pipeline.Workspace)/secret2.txt"
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Pipeline.Workspace)/*.txt'
    artifact: 'drop'
    publishLocation: 'pipeline'


- script: |
    echo Add other tasks to build, test, and deploy your project.
    echo See https://aka.ms/yaml
  displayName: 'Run a multi-line script'
 
- task: azurekeyvaultactions@2
  inputs:
    ConnectedServiceName: 'Trainingdevopsyamlserviceconn'
    Action: 'GetSecret'
    KeyVaultName: 'dev-devops-demo-keyvault'
    SecretName: 'EncryptionKey'
    VariableName: 'thesecret'
- task: cboroson-WriteSecrets@1
  inputs:
    ConnectedServiceName: 'Trainingdevopsyamlserviceconn'
    resourceGroupName: 'yaml-introduction-demo'
    KeyVaultName: 'dev-we-devops-keyvault'
    SecretName: 'EncryptionKey'
    SecretValue: $(thesecret)