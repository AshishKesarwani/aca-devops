parameters:
   BuildConfiguration: Release
   TargetFramework: netcoreapp3.1

stages:
- stage: Build
  jobs:
  - job: DotNetCore
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: DotNetCoreCLI@2
      displayName: 'Restore Packages'
      inputs:
        command: restore
        projects: 'src\Application\Yaml_Introduction.App.sln'

    - task: DotNetCoreCLI@2
      displayName: 'Build and Package Application'
      inputs:
        command: publish
        publishWebProjects: false
        projects: 'src\Application\Yaml_Introduction.App\Yaml_Introduction.App.csproj'
        arguments: '--configuration ${{ parameters.BuildConfiguration }} --framework ${{ parameters.TargetFramework }}'
        zipAfterPublish: True
        modifyOutputPath: false

    - task: CopyFiles@2
      displayName: 'Copy Application Package'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)\src\Application\Yaml_Introduction.App\bin\${{ parameters.BuildConfiguration }}\${{ parameters.TargetFramework }}'
        Contents: '**\*.zip'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\Packages'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifacts'
      inputs:
        path: '$(Build.ArtifactStagingDirectory)\Packages'
        artifact: Api


  - job: Publish_Resources
    pool:
      name: 'Hosted VS2017'
    steps:
    - task: CopyFiles@2
      displayName: 'Copy ARM Templates'
      inputs:
        SourceFolder: 'src\Application\Yaml_Introduction.Resources\Templates'
        Contents: |
         *.json
         !**local**
        TargetFolder: '$(Build.ArtifactStagingDirectory)\Templates'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish ARM Templates'
      inputs:
        path: '$(Build.ArtifactStagingDirectory)\Templates'
        artifact: Resources

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Scripts'
      inputs:
        path: deploy/scripts
        artifact: Scripts