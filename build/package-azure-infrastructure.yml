name: 1.0$(Rev:.r)

trigger:
 branches:
   include:
   - main
 paths:
   include:
   - deploy/azure-infrastructure*.json

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
- template: variables/azure-landscape.yml
- template: variables/environments/environment-dev.yml

stages:
  - stage: verify
    displayName: Verify
    jobs:
      - job: verify
        displayName: Verify Azure Artifacts
        steps:
          # Verify the ARM template is semantically correct
          - task: AzureCLI@2
            displayName: Validate ARM template
            inputs:
              azureSubscription: '$(Azure.Subscription.ServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: 'az deployment group validate --resource-group $(Azure.ResourceGroup.Name) --template-file azure-infrastructure.json --parameters azure-infrastructure.parameters.ci.json'
              workingDirectory: deploy

  # package & publish our Azure artifacts
  - stage: publish
    displayName: Publish
    dependsOn: verify
    jobs:
      - job: publish
        displayName: Publish Azure Artifacts
        steps:
          # Copy the required ARM templates
          - task: CopyFiles@2
            displayName: Copy ARM templates
            inputs:
              SourceFolder: deploy
              Contents: |
                azure-infrastructure.json
                azure-infrastructure.parameters.json
              TargetFolder: '$(build.artifactstagingdirectory)/artifact/arm'
